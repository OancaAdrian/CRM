<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRM - Căutare firmă și Agenda</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f6f8fa; color:#111; margin:0; padding:24px; }
    .container { max-width:1100px; margin:20px auto; display:grid; grid-template-columns: 1fr 420px; gap:20px; }
    .card { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(15,23,42,0.06); }
    h1 { margin:0 0 12px 0; font-size:18px; }
    label { display:block; margin-bottom:8px; font-weight:600; }
    input[type="text"], textarea, input[type="number"], select, input[type="date"] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; font-size:15px; }
    button { margin-top:8px; padding:8px 12px; background:#0366d6; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary { background:#e5e7eb; color:#111; }
    .muted { color:#6b7280; font-size:13px; margin-top:8px; }
    .list-item { padding:10px; border:1px solid #e6eef8; border-radius:8px; margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .agenda-slot { padding:10px; border-radius:8px; margin-top:8px; background:#f8fafc; border:1px solid #eef2ff; cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .overdue { background:#fff4f2; border-color:#ffd6cc; }
    .small { font-size:13px; color:#6b7280; }
    .name-button { font-weight:700; background:none; border:none; padding:0; cursor:pointer; color:#0366d6; font-size:15px; text-align:left; }
    #agenda { max-height:720px; overflow:auto; }
    .field { margin-top:8px; }
    .caen-desc { color:#111; display:block; margin-top:4px; white-space:pre-wrap; }
    .suggested { margin-top:6px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .btn-link { background:transparent;border:1px solid #e5e7eb;color:#111;padding:6px 8px;border-radius:6px;cursor:pointer }
    #error-notice { color:#b91c1c; margin-top:8px; min-height:18px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="search-card">
      <h1>Găsește firmă după CUI sau nume</h1>
      <label for="cui">Introduceți CUI sau nume</label>
      <input id="cui" type="text" placeholder="ex: 12818268 sau East Truck" />
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px">
        <button id="search">Caută</button>
        <button id="back" class="secondary" style="display:none">Înapoi</button>
        <div class="muted">Rezultatele apar mai jos. Click pe nume pentru detalii.</div>
      </div>

      <div id="error-notice" class="muted"></div>
      <div id="results" style="margin-top:12px"></div>
    </div>

    <div class="card" id="agenda-card">
      <h1>Agenda zilnică</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="small muted" id="agenda-date">Se încarcă...</div>
        <div style="flex:1"></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="refresh-agenda" class="secondary">Reîmprospătează</button>
        <input id="agenda-day" type="date" style="flex:1" />
      </div>
      <div id="agenda" style="margin-top:12px"></div>
    </div>
  </div>

  <template id="detail-template">
    <div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:700" data-name>—</div>
          <div class="small" data-meta>—</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="small"><strong>Județ:</strong> <span data-judet>—</span></div>
        <div class="small"><strong>Localitate:</strong> <span data-localitate>—</span></div>
        <div class="small"><strong>Cod CAEN:</strong> <span data-caen>—</span></div>
        <div class="small"><strong>Descriere CAEN:</strong> <span class="caen-desc" data-caen-desc>—</span></div>
        <div class="small"><strong>Licențe:</strong> <span data-licente>—</span></div>

        <div class="small" style="margin-top:10px"><strong>Cifră de afaceri:</strong> <span data-cifra>—</span></div>
        <div class="small"><strong>Profit:</strong> <span data-profit>—</span></div>
        <div class="small"><strong>Număr angajați:</strong> <span data-angajati>—</span></div>
      </div>

      <h4 style="margin-top:12px">Activități</h4>
      <div data-activities style="margin-top:8px">Se încarcă activități…</div>

      <h4 style="margin-top:12px">Adaugă activitate</h4>
      <div style="margin-top:6px">
        <label>Tip activitate</label>
        <select data-act-type>
          <option value="1">contact</option>
          <option value="2">oferta</option>
          <option value="3">contract</option>
          <option value="4">contact in vederea livrarii</option>
          <option value="5">livrare</option>
          <option value="6">feedback livrare</option>
          <option value="7">vizita</option>
          <option value="8">intalnire</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label>Programează</label>
        <select data-act-programare>
          <option value="">-- selectează --</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label>Comentariu</label>
        <textarea data-act-comment placeholder="comentariu"></textarea>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <button data-act-add>Adaugă</button>
        <span data-act-result class="small"></span>
      </div>

      <h4 style="margin-top:16px">Persoane de contact</h4>
      <div data-contacts class="small">Se încarcă...</div>

      <div style="margin-top:8px">
        <div class="field">
          <label>Nume</label>
          <input data-contact-name type="text" />
        </div>
        <div class="field">
          <label>Telefon</label>
          <input data-contact-phone type="text" />
        </div>
        <div class="field">
          <label>Email</label>
          <input data-contact-email type="email" />
        </div>
        <div class="field">
          <label>Rol</label>
          <input data-contact-role type="text" />
        </div>
        <div class="field" style="display:flex; gap:8px; align-items:center;">
          <button data-contact-add>Adaugă persoană</button>
          <span data-contact-result class="small"></span>
        </div>
      </div>
    </div>
  </template>

  <script>
    const btn = document.getElementById('search');
    const backBtn = document.getElementById('back');
    const input = document.getElementById('cui');
    const results = document.getElementById('results');
    const errorNotice = document.getElementById('error-notice');
    const detailTpl = document.getElementById('detail-template').content;

    const agendaDayInput = document.getElementById('agenda-day');
    const agendaDateLabel = document.getElementById('agenda-date');
    const agendaDiv = document.getElementById('agenda');
    const refreshAgendaBtn = document.getElementById('refresh-agenda');

    let _searchLock = false;
    let _lastQuery = "";
    let _lastResults = [];

    function fmtNumber(value) {
      if (value == null) return '—';
      try {
        const num = Number(String(value).replace(/[^\d\-\.]/g,''));
        if (Number.isNaN(num)) return String(value);
        return num.toLocaleString('ro-RO');
      } catch (e) { return String(value); }
    }

    function debounce(fn, wait) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }

    async function loadActivitiesList(cui, container) {
      container.textContent = 'Se încarcă activități…';
      try {
        const res = await fetch(`/api/firms/${encodeURIComponent(cui)}`, { headers: { accept: 'application/json' } });
        if (!res.ok) {
          container.textContent = 'Eroare la încărcare activități.';
          return;
        }
        const json = await res.json();
        const acts = json.activities || [];
        if (acts.length === 0) {
          container.innerHTML = '<div class="muted">Nu există activități.</div>';
          return;
        }
        const list = document.createElement('div');
        acts.forEach(a => {
          const el = document.createElement('div');
          el.className = 'agenda-slot';
          el.style.borderBottom = '1px solid #eef2ff';
          const when = a.created_at ? a.created_at.split('T')[0] : '—';
          const sched = a.scheduled_date ? ` | Programată: ${a.scheduled_date}` : '';
          const prog = (a.programare_label !== null && a.programare_label !== undefined) ? ` | Progr: ${a.programare_label}` : '';
          const type_text = a.type_name ? ` | Tip: ${a.type_name}` : (a.type_id ? ` | Tip: ${a.type_id}` : '');
          el.textContent = `${when} — ${a.comment || '(fără comentariu)'}${type_text}${prog}${sched}`;
          list.appendChild(el);
        });
        container.innerHTML = '';
        container.appendChild(list);
      } catch (err) {
        container.textContent = 'Eroare la încărcare activități: ' + (err.message || err);
      }
    }

    async function loadContactsForUI(cui, contactsContainer) {
      contactsContainer.textContent = 'Se încarcă...';
      try {
        const res = await fetch(`/api/firms/${encodeURIComponent(cui)}/contacts`, { headers: { accept: 'application/json' } });
        if (!res.ok) {
          let txt = null;
          try { txt = await res.text(); } catch(e) {}
          contactsContainer.textContent = `Eroare la încărcare contacte: ${res.status}` + (txt ? ` — ${txt}` : '');
          return;
        }
        let list;
        try { list = await res.json(); } catch (e) {
          contactsContainer.textContent = 'Eroare parsare contacte';
          return;
        }
        if (!Array.isArray(list) || list.length === 0) {
          contactsContainer.innerHTML = '<div class="muted">Nicio persoană de contact.</div>';
          return;
        }
        const holder = document.createElement('div');
        list.forEach(c => {
          const row = document.createElement('div');
          row.className = 'small';
          row.textContent = `${c.name} (${c.role || '—'}) | Tel: ${c.phone || '—'} | Email: ${c.email || '—'}`;
          holder.appendChild(row);
        });
        contactsContainer.innerHTML = '';
        contactsContainer.appendChild(holder);
      } catch (e) {
        contactsContainer.textContent = 'Eroare la încărcare contacte: ' + (e.message || e);
      }
    }

    async function fetchDetails(cui, container) {
      container.textContent = 'Se încarcă detalii…';
      try {
        const r = await fetch(`/api/firms/${encodeURIComponent(cui)}`, { headers: { accept: 'application/json' } });
        if (!r.ok) {
          container.textContent = 'Detalii indisponibile.';
          return null;
        }
        const json = await r.json();

        const clone = document.importNode(detailTpl, true);
        clone.querySelector('[data-name]').textContent = json.name || '(nume lipsă)';
        clone.querySelector('[data-meta]').textContent = `CUI: ${json.cui || '—'} · Județ: ${json.judet || '—'}`;

        clone.querySelector('[data-judet]').textContent = json.judet || '—';
        clone.querySelector('[data-localitate]').textContent = json.localitate || '—';
        clone.querySelector('[data-licente]').textContent = (json.licente ?? json.numar_licente) ?? '—';

        clone.querySelector('[data-cifra]').textContent = (json.cifra_afaceri != null) ? fmtNumber(json.cifra_afaceri) : '—';
        clone.querySelector('[data-profit]').textContent = (json.profit_net != null) ? fmtNumber(json.profit_net) : '—';
        clone.querySelector('[data-angajati]').textContent = (json.angajati != null) ? String(json.angajati) : '—';

        clone.querySelector('[data-caen]').textContent = (json.caen || '').toString().trim() || '—';
        const rawDesc = (json.caen_description || '').toString();
        const decodedDesc = (function(s){ try{ const t=document.createElement('textarea'); t.innerHTML=s; return t.value; }catch(e){return s;} })(rawDesc);
        const cleanDesc = decodedDesc.replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
        clone.querySelector('[data-caen-desc]').textContent = cleanDesc || '—';

        const activitiesContainer = clone.querySelector('[data-activities]');
        await loadActivitiesList(cui, activitiesContainer);

        const contactsContainer = clone.querySelector('[data-contacts]');
        await loadContactsForUI(cui, contactsContainer);

        // populate programare select
        const programareSelect = clone.querySelector('[data-act-programare]');
        (async function populateProgramare() {
          try {
            const rr = await fetch('/api/reprogram_options', { headers: { accept: 'application/json' } });
            if (!rr.ok) return;
            const opts = await rr.json();
            opts.forEach(opt => {
              const o = document.createElement('option');
              o.value = opt.id;
              o.textContent = opt.label;
              programareSelect.appendChild(o);
            });
          } catch (e) {
            console.warn('Failed to load reprogram_options', e);
          }
        })();

        const contactName = clone.querySelector('[data-contact-name]');
        const contactPhone = clone.querySelector('[data-contact-phone]');
        const contactEmail = clone.querySelector('[data-contact-email]');
        const contactRole = clone.querySelector('[data-contact-role]');
        const contactAddBtn = clone.querySelector('[data-contact-add]');
        const contactResult = clone.querySelector('[data-contact-result]');

        async function reloadContacts() { await loadContactsForUI(cui, contactsContainer); }

        contactAddBtn.addEventListener('click', async () => {
          contactResult.textContent = '';
          const payload = {
            firm_cui: String(cui),
            name: contactName.value.trim(),
            phone: contactPhone.value.trim() || null,
            email: contactEmail.value.trim() || null,
            role: contactRole.value.trim() || null
          };
          if (!payload.name) { contactResult.textContent = 'Numele este necesar.'; return; }
          try {
            contactAddBtn.disabled = true;
            const res = await fetch('/api/contacts', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.status === 201) {
              contactResult.textContent = 'Persoana a fost adăugată.';
              contactResult.style.color = '#059669';
              contactName.value = '';
              contactPhone.value = '';
              contactEmail.value = '';
              contactRole.value = '';
              await reloadContacts();
            } else {
              const j = await res.json().catch(()=>null);
              contactResult.textContent = 'Eroare: ' + res.status + (j && j.detail ? ' - ' + j.detail : '');
              contactResult.style.color = '#b91c1c';
            }
          } catch (e) {
            contactResult.textContent = 'Eroare rețea: ' + (e.message || e);
            contactResult.style.color = '#b91c1c';
          } finally {
            contactAddBtn.disabled = false;
            setTimeout(() => { contactResult.textContent = ''; }, 3000);
          }
        });

        // activity add
        const addBtn = clone.querySelector('[data-act-add]');
        const commentInput = clone.querySelector('[data-act-comment]');
        const typeInput = clone.querySelector('[data-act-type]');
        const actResult = clone.querySelector('[data-act-result]');
        const activitiesContainerRef = activitiesContainer;

        addBtn.addEventListener('click', async () => {
          actResult.textContent = '';
          const comment = commentInput.value.trim();
          const typeVal = Number(typeInput.value) || 1;
          const progRaw = programareSelect.value;
          const progId = progRaw === '' ? null : Number(progRaw);

          if (!comment) { actResult.textContent = 'Comentariu este necesar.'; return; }

          const payload = {
            firm_id: String(cui),
            activity_type_id: typeVal,
            comment: comment,
            programare_id: progId,
            scheduled_date: null
          };
          try {
            addBtn.disabled = true;
            const res = await fetch('/api/activities', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.status === 201 || res.status === 200) {
              const j = await res.json().catch(()=>null);
              let msg = 'Activitate salvată.';
              if (j && j.scheduled_date) msg += ' Programată pentru: ' + j.scheduled_date;
              if (res.status === 200) msg = 'Activitate actualizată.';
              actResult.textContent = msg;
              actResult.style.color = '#059669';
              setTimeout(() => { actResult.textContent = ''; }, 3000);
              commentInput.value = '';
              programareSelect.value = '';
              typeInput.value = '1';
              await loadActivitiesList(cui, activitiesContainerRef);
              await safeLoadAgenda();
            } else {
              const j = await res.json().catch(()=>null);
              actResult.textContent = 'Eroare server: ' + res.status + (j && j.detail ? ' - ' + j.detail : '');
            }
          } catch (err) {
            actResult.textContent = 'Eroare rețea: ' + (err.message || err);
          } finally {
            addBtn.disabled = false;
          }
        });

        container.innerHTML = '';
        container.appendChild(clone);
        return json;
      } catch (err) {
        container.textContent = 'Eroare la încărcare detalii: ' + (err.message || err);
        return null;
      }
    }

    async function search() {
      const q = input.value.trim();
      if (!q) {
        errorNotice.textContent = 'Introduceți un CUI sau un nume valid.';
        return;
      }
      if (_searchLock || q === _lastQuery) return;
      _searchLock = true;
      _lastQuery = q;

      errorNotice.textContent = '';
      results.innerHTML = '';

      btn.disabled = true;
      btn.textContent = 'Se caută...';
      try {
        const res = await fetch(`/search?q=${encodeURIComponent(q)}&limit=10`, { headers: { accept: 'application/json' } });
        if (!res.ok) {
          const j = await res.json().catch(()=>null);
          errorNotice.textContent = (j && j.detail) ? String(j.detail) : `Eroare server: ${res.status}`;
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          results.innerHTML = '<div class="muted">Nu s-au găsit rezultate.</div>';
          return;
        }

        _lastResults = data;

        const list = document.createElement('div');
        list.id = 'results-list';

        data.forEach(item => {
          const cui = item.cui ?? item.id ?? '—';
          const row = document.createElement('div');
          row.className = 'list-item';
          row.dataset.cui = cui;

          const summary = document.createElement('div');
          summary.style.display = 'flex';
          summary.style.flexDirection = 'column';
          const titleBtn = document.createElement('button');
          titleBtn.className = 'name-button';
          titleBtn.textContent = item.name ?? '(nume lipsă)';
          summary.appendChild(titleBtn);

          const meta = document.createElement('div');
          meta.className = 'small';
          const judet = item.judet ?? '—';
          const cifra = item.cifra_afaceri ?? item.cifra_de_afaceri_neta ?? null;
          const lic = item.licente ?? item.numar_licente ?? '—';
          meta.textContent = `CUI: ${cui} · Județ: ${judet} · Cifră afaceri: ${cifra ? fmtNumber(cifra) : '—'} · Licențe: ${lic}`;
          summary.appendChild(meta);

          row.appendChild(summary);

          titleBtn.addEventListener('click', async () => {
            results.innerHTML = '';
            const single = document.createElement('div');
            single.className = 'list-item';
            single.style.flexDirection = 'column';
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            const titleText = document.createElement('div');
            titleText.innerHTML = `<strong>${item.name}</strong><div class="small" style="margin-top:6px">CUI: ${cui} · Județ: ${item.judet ?? '—'}</div>`;
            header.appendChild(titleText);
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Înapoi';
            closeBtn.className = 'secondary';
            closeBtn.addEventListener('click', () => {
              renderResults(_lastResults);
            });
            header.appendChild(closeBtn);
            single.appendChild(header);

            const detailsHolder = document.createElement('div');
            detailsHolder.style.marginTop = '12px';
            single.appendChild(detailsHolder);

            results.appendChild(single);

            await fetchDetails(cui, detailsHolder);

            single.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });

          list.appendChild(row);
        });

        results.appendChild(list);
        backBtn.style.display = 'none';
      } catch (err) {
        errorNotice.textContent = 'Eroare rețea: ' + (err && err.message ? err.message : String(err));
      } finally {
        _searchLock = false;
        btn.disabled = false;
        btn.textContent = 'Caută';
      }
    }

    async function openFirmFromAgenda(cui) {
      results.innerHTML = '';
      const single = document.createElement('div');
      single.className = 'list-item';
      single.style.flexDirection = 'column';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';

      const titleText = document.createElement('div');
      titleText.innerHTML = `<strong>Detalii firmă</strong><div class="small" style="margin-top:6px">CUI: ${cui}</div>`;
      header.appendChild(titleText);

      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Înapoi';
      closeBtn.className = 'secondary';
      closeBtn.addEventListener('click', () => { results.innerHTML = ''; });
      header.appendChild(closeBtn);

      single.appendChild(header);

      const detailsHolder = document.createElement('div');
      detailsHolder.style.marginTop = '12px';
      single.appendChild(detailsHolder);

      results.appendChild(single);

      await fetchDetails(cui, detailsHolder);
      single.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    // expose globally so handlers can call it
    window.openFirmFromAgenda = openFirmFromAgenda;

    // ---- loadAgenda (scheduled + overdue + nearby + suggested) ----
    async function loadAgenda(day = null) {
      const d = day || agendaDayInput.value || new Date().toISOString().slice(0,10);
      agendaDateLabel.textContent = `Agenda pentru: ${d}`;
      try {
        const res = await fetch(`/api/agenda?day=${d}`, { headers: { accept: 'application/json' } });
        if (!res.ok) {
          agendaDiv.innerHTML = '<div class="muted">Eroare la încărcare agenda.</div>';
          return;
        }
        const json = await res.json();
        const scheduled = json.scheduled || [];
        const overdue = json.overdue || [];
        const nearby = json.nearby || [];
        const suggested = json.suggested || [];

        agendaDiv.innerHTML = '';

        // Scheduled section
        const hScheduled = document.createElement('div'); hScheduled.style.fontWeight = '700'; hScheduled.style.marginTop = '6px'; hScheduled.textContent = 'Activități programate';
        agendaDiv.appendChild(hScheduled);
        if (scheduled.length === 0) {
          const empty = document.createElement('div'); empty.className='muted'; empty.textContent = 'Nicio activitate programată pentru această zi.';
          agendaDiv.appendChild(empty);
        } else {
          scheduled.forEach(a => {
            const el = document.createElement('div'); el.className = 'agenda-slot';
            const left = document.createElement('div');
            left.style.display = 'flex'; left.style.flexDirection='column'; left.style.gap='6px';
            const topRow = document.createElement('div'); topRow.style.display='flex'; topRow.style.justifyContent='space-between'; topRow.style.alignItems='center';
            const titleBtn = document.createElement('button'); titleBtn.className='name-button';
            titleBtn.textContent = a.firm_name || a.comment || a.cui;
            titleBtn.dataset.cui = String(a.cui ?? '');
            titleBtn.addEventListener('click', (ev) => {
              const cui = ev.currentTarget.dataset.cui;
              if (!cui) return;
              input.value = cui;
              if (typeof window.openFirmFromAgenda === 'function') window.openFirmFromAgenda(cui);
            });
            topRow.appendChild(titleBtn);

            const actions = document.createElement('div');
            actions.style.display='flex'; actions.style.gap='8px';
            const completeBtn = document.createElement('button');
            completeBtn.textContent = 'Marchează finalizată';
            completeBtn.className = 'btn-link';
            completeBtn.addEventListener('click', async (ev) => {
              ev.stopPropagation();
              completeBtn.disabled = true;
              await markActivityComplete(a.id);
              await safeLoadAgenda(d);
            });
            actions.appendChild(completeBtn);
            topRow.appendChild(actions);

            const meta = document.createElement('div'); meta.className='small';
            meta.textContent = `Firmă: ${a.cui} | Programare: ${a.programare_label ?? '—'} | Programată: ${a.scheduled_date ?? '—'}`;

            left.appendChild(topRow);
            left.appendChild(meta);

            el.appendChild(left);
            agendaDiv.appendChild(el);
          });
        }

        // Overdue
        if (overdue.length) {
          const h = document.createElement('div'); h.style.fontWeight='700'; h.style.marginTop='12px'; h.textContent='Restanțe';
          agendaDiv.appendChild(h);
          overdue.forEach(a => {
            const el = document.createElement('div'); el.className='agenda-slot overdue';
            const titleBtn = document.createElement('button'); titleBtn.className='name-button';
            titleBtn.textContent = a.firm_name || a.comment || a.cui;
            titleBtn.dataset.cui = String(a.cui ?? '');
            titleBtn.addEventListener('click', (ev) => {
              const cui = ev.currentTarget.dataset.cui;
              if (!cui) return;
              input.value = cui;
              if (typeof window.openFirmFromAgenda === 'function') window.openFirmFromAgenda(cui);
            });
            const meta = document.createElement('div'); meta.className='small'; meta.style.marginTop='6px';
            meta.textContent = `Firmă: ${a.cui} | Programare: ${a.programare_label ?? '—'} | Programată: ${a.scheduled_date ?? '—'}`;
            el.appendChild(titleBtn); el.appendChild(meta); agendaDiv.appendChild(el);
          });
        }

        // Nearby
        if (nearby.length) {
          const h2 = document.createElement('div'); h2.style.fontWeight='700'; h2.style.marginTop='12px'; h2.textContent='Programate în zilele următoare';
          agendaDiv.appendChild(h2);
          nearby.forEach(a => {
            const el = document.createElement('div'); el.className='agenda-slot';
            const titleBtn = document.createElement('button'); titleBtn.className='name-button';
            titleBtn.textContent = a.firm_name || a.comment || a.cui;
            titleBtn.dataset.cui = String(a.cui ?? '');
            titleBtn.addEventListener('click', (ev) => {
              const cui = ev.currentTarget.dataset.cui;
              if (!cui) return;
              input.value = cui;
              if (typeof window.openFirmFromAgenda === 'function') window.openFirmFromAgenda(cui);
            });
            const meta = document.createElement('div'); meta.className='small'; meta.style.marginTop='6px';
            meta.textContent = `Firmă: ${a.cui} | Programare: ${a.programare_label ?? '—'} | Programată: ${a.scheduled_date ?? '—'}`;
            el.appendChild(titleBtn); el.appendChild(meta); agendaDiv.appendChild(el);
          });
        }

        // Suggested section (top5) — names clickable, no extra buttons
        const hSug = document.createElement('div'); hSug.style.fontWeight='700'; hSug.style.marginTop='16px'; hSug.textContent='Activități sugerate';
        agendaDiv.appendChild(hSug);
        if (!Array.isArray(suggested) || suggested.length === 0) {
          const emptyS = document.createElement('div'); emptyS.className='muted'; emptyS.textContent='Nicio sugestie momentan.';
          agendaDiv.appendChild(emptyS);
        } else {
          suggested.forEach(s => {
            const item = document.createElement('div'); item.className='agenda-slot suggested';
            const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column'; left.style.gap='6px';
            const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center';
            const nameBtn = document.createElement('button'); nameBtn.className='name-button';
            nameBtn.textContent = `${s.rank}. ${s.denumire || s.cui}`;
            nameBtn.dataset.cui = String(s.cui ?? '');
            nameBtn.addEventListener('click', (ev) => {
              const cui = ev.currentTarget.dataset.cui;
              if (!cui) return;
              input.value = cui;
              if (typeof window.openFirmFromAgenda === 'function') window.openFirmFromAgenda(cui);
            });
            top.appendChild(nameBtn);
            const meta = document.createElement('div'); meta.className='small';
            meta.textContent = `Licențe: ${s.licente ?? '—'} · CA: ${s.cifra_afaceri ? fmtNumber(s.cifra_afaceri) : '—'}`;
            left.appendChild(top); left.appendChild(meta);
            item.appendChild(left); agendaDiv.appendChild(item);
          });
        }

      } catch (err) {
        agendaDiv.innerHTML = '<div class="muted">Eroare la încărcare agenda: ' + (err.message || err) + '</div>';
      }
    }

    async function markSuggestedUsed(cuis) {
      try {
        const res = await fetch('/api/suggested_mark_used', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cuis)
        });
        if (!res.ok) return false;
        return true;
      } catch (e) {
        return false;
      }
    }

    async function markActivityComplete(activityId) {
      try {
        const res = await fetch(`/api/activities/${activityId}/complete`, { method: 'POST' });
        if (!res.ok) return false;
        return true;
      } catch (e) {
        return false;
      }
    }

    async function safeLoadAgenda(day = null) {
      try { await loadAgenda(day); } catch (e) { console.warn('safeLoadAgenda failed', e); if (errorNotice) errorNotice.textContent = 'Eroare încărcare agenda (non-fatal).'; }
    }

    async function safeFetchDetails(cui, container) {
      try { return await fetchDetails(cui, container); } catch (e) { console.warn('safeFetchDetails failed', e); container.textContent = 'Detalii indisponibile.'; return null; }
    }

    setTimeout(() => {
      try {
        const today = new Date().toISOString().slice(0,10);
        agendaDayInput.value = today;
        safeLoadAgenda();
      } catch (e) {
        if (errorNotice) errorNotice.textContent = 'Eroare la inițializare interfață.';
      }
    }, 50);

    refreshAgendaBtn.addEventListener('click', () => safeLoadAgenda(agendaDayInput.value));
    btn.addEventListener('click', () => search());
    input.addEventListener('input', debounce(() => { if (input.value.trim()) search(); }, 350));
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); search(); } });
    backBtn.addEventListener('click', () => { renderResults(_lastResults); });
    input.focus();
  </script>
</body>
</html>
