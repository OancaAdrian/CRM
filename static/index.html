<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRM — Interfață</title>
  <meta name="app-password" content="5864">

  <style>
    :root{ --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#0b5fff; --danger:#d0342c; --radius:10px; --pad:14px; --shadow:0 6px 18px rgba(18,23,33,0.06); }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#f7f9fc,#f2f5fb);}
    .wrap{max-width:1100px;margin:28px auto;padding:20px;display:grid;gap:18px;grid-template-columns:1fr 380px;}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;}
    h1{margin:0;font-size:20px;color:#0f1724;}
    .sub{color:var(--muted);font-size:13px}
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad);}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    input[type="text"],input[type="date"]{padding:10px 12px;border:1px solid #e6e9ef;border-radius:8px;background:#fff}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,95,255,0.12)}
    .muted{color:var(--muted);font-size:13px}
    .results{display:flex;flex-direction:column;gap:8px}
    .card-item{padding:12px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef2ff;display:flex;justify-content:space-between;align-items:center}
    .card-item a{color:#0b1b3b;font-weight:600;text-decoration:none}
    .card-meta{color:var(--muted);font-size:13px}
    .agenda-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto;padding-right:6px}
    .agenda-item{padding:10px;border-radius:8px;background:#fff;border:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}
    pre.debug{white-space:pre-wrap;word-break:break-word;background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;font-size:13px;max-height:160px;overflow:auto}
    #pw-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
    #pw-box{width:360px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.45);text-align:center}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr;padding:12px} }
  </style>

  <script>
    // API base + app password
    window.__API_BASE__ = (function(){ try{ return window.location.origin }catch(e){ return '' } })();
    (function(){ const meta = document.querySelector('meta[name="app-password"]'); window.__APP_PASSWORD__ = meta ? meta.getAttribute('content')||'' : ''; })();
<script>
(function(){
  const orig = window.fetch.bind(window);
  window.fetch = async function(input, init){
    init = init || {};
    init.headers = new Headers(init.headers || {});
    let url = typeof input === 'string' ? input : (input && input.url) || '';

    url = url.replace(/onender\.com|openender\.com/gi, window.location.hostname);

    if (url.startsWith('/search')) {
      url = `/api/search${url.slice('/search'.length)}`;
    }

    if (url.startsWith('/api') || url.startsWith('/admin') || url.startsWith('/')) {
      url = (window.__API_BASE__ || location.origin) + url;
    }

    if ((url.includes('/api/') || url.includes('/admin/')) && window.__APP_PASSWORD__) {
      if (!init.headers.get('x-app-password')) init.headers.set('x-app-password', window.__APP_PASSWORD__);
    }

    if (init.body && typeof init.body === 'object' && !init.headers.get('Content-Type')) {
      init.headers.set('Content-Type','application/json');
      init.body = JSON.stringify(init.body);
    }

    return orig(url, init);
  };
})();
</script>

    // Robust fetch wrapper: fix host typos, normalize legacy routes, prefix relative, inject x-app-password
    (function(){
      const orig = window.fetch.bind(window);
      window.fetch = async function(input, init){
        init = init || {};
        init.headers = new Headers(init.headers || {});
        let url = typeof input === 'string' ? input : (input && input.url) || '';
        try {
          // fix hostname typos that appeared in builds
          url = url.replace(/onender\.com|openender\.com|n3-openender\.com|cm-1sq\.onrender\.com/gi, window.location.hostname);

          // map legacy agenda2 -> /api/agenda?day=YYYY-MM-DD
          const a2 = url.match(/\/api\/agenda2\/day\/(\d{4}-\d{2}-\d{2})/);
          if (a2) url = `/api/agenda?day=${encodeURIComponent(a2[1])}`;
          url = url.replace(/\/api\/agenda2\?date=([^&]+)/, (m,d)=>`/api/agenda?day=${encodeURIComponent(d)}`);

          // map legacy /search -> /api/search (adjust if your backend exposes /search at root instead)
          if (url.startsWith('/search')) url = `/api/search${url.slice('/search'.length)}`;

          // prefix relative paths with origin
          if (url.startsWith('/api') || url.startsWith('/admin') || url.startsWith('/api/')) {
            url = (window.__API_BASE__ || location.origin) + url;
          } else if (url.startsWith('/')) {
            url = (window.__API_BASE__ || location.origin) + url;
          }

          // inject app password header for protected endpoints
          if ((url.includes('/api/') || url.includes('/admin/')) && window.__APP_PASSWORD__) {
            if (!init.headers.get('x-app-password')) init.headers.set('x-app-password', window.__APP_PASSWORD__);
          }

          // stringify plain object bodies
          if (init.body && typeof init.body === 'object' && !init.headers.get('Content-Type')) {
            init.headers.set('Content-Type','application/json');
            init.body = JSON.stringify(init.body);
          }
        } catch(e){ console.error('fetch wrapper error', e); }
        return orig(url, init);
      };
    })();
  </script>
</head>
<body>
  <!-- password overlay (sessionStorage key) -->
  <div id="pw-overlay" aria-hidden="false">
    <div id="pw-box" role="dialog" aria-label="Parola acces">
      <h2>Acces restricționat</h2>
      <div>Introduceți parola pentru a vizualiza aplicația</div>
      <div style="margin-top:12px;">
        <input id="boot-password" type="password" placeholder="Parola" style="width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px" />
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button id="pw-submit">Deschide</button>
        <button id="pw-cancel" class="ghost">Închide</button>
      </div>
      <div id="pw-error" style="color:#b91c1c;margin-top:8px;min-height:18px"></div>
      <div style="margin-top:8px;color:var(--muted);font-size:13px">Parola se reține pe sesiune</div>
    </div>
  </div>

  <div class="wrap" id="app-root" aria-hidden="true">
    <header>
      <div>
        <h1>CRM</h1>
        <div class="sub">Interfață de administrare — căutare firme și agenda</div>
      </div>
      <div class="sub">API: <strong id="apiBaseDisplay"></strong></div>
    </header>

    <section class="panel">
      <div class="row">
        <label for="q">Găsește firmă după CUI sau nume</label>
        <input id="q" type="text" placeholder="Introduceți CUI sau nume" />
        <button id="btnSearch">Caută</button>
        <button id="btnClear" class="ghost">Curăță</button>
      </div>
      <div id="searchStatus" class="muted">Rezultatele apar mai jos. Click pe nume pentru detalii.</div>
      <div id="results" class="results" aria-live="polite"></div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="loadSample" class="ghost">Exemplu: 10890801</button>
        <div style="margin-left:auto" class="muted">Parolă app: <strong id="pwSet"></strong></div>
      </div>
    </section>

    <aside class="panel">
      <div class="row" style="margin-bottom:8px">
        <label for="agendaDay">Agenda pentru</label>
        <input id="agendaDay" type="date" />
        <button id="btnAgenda">Reîmprospătează</button>
      </div>
      <div id="agendaStatus" class="muted" style="margin-bottom:8px">Agenda afișează elementele planificate</div>
      <div id="agendaList" class="agenda-list" aria-live="polite"></div>
      <div style="margin-top:12px">
        <button id="btnRefreshAll" class="ghost">Reîncarcă topuri</button>
      </div>
    </aside>

    <section class="panel" style="grid-column:1/-1">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Debug</div>
        <div class="muted">Informații rapide</div>
      </div>
      <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
        <div style="flex:1"><div class="muted">API base</div><div id="apiBase" style="font-weight:600"></div></div>
        <div style="flex:1;min-width:200px"><div class="muted">App password (meta)</div><div id="appPw" style="font-weight:600"></div></div>
        <div style="flex:1;min-width:200px"><div class="muted">Health</div><div id="healthStatus" style="font-weight:600"></div></div>
      </div>
      <div style="margin-top:12px"><div class="muted">Last response</div><pre id="debugPre" class="debug">— niciun request recent —</pre></div>
    </section>

    <footer style="grid-column:1/-1;display:flex;justify-content:space-between;color:var(--muted);font-size:13px">
      <div>© CRM • 2025</div>
      <div class="muted">Rendered on <span id="renderHost"></span></div>
    </footer>
  </div>

  <template id="detail-template">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div data-name style="font-weight:700">(nume)</div><div data-meta class="muted"></div></div>
        <div class="card-meta" data-right></div>
      </div>
      <div data-activities style="margin-top:8px"></div>
      <div data-contacts style="margin-top:8px" class="small muted"></div>
    </div>
  </template>

  <script>
    // UI init
    const apiBaseDisplay = document.getElementById('apiBaseDisplay');
    const apiBase = document.getElementById('apiBase');
    const appPw = document.getElementById('appPw');
    const pwSet = document.getElementById('pwSet');
    const healthStatus = document.getElementById('healthStatus');
    const debugPre = document.getElementById('debugPre');
    const renderHost = document.getElementById('renderHost');

    apiBaseDisplay.textContent = window.__API_BASE__ || location.origin;
    apiBase.textContent = window.__API_BASE__ || location.origin;
    appPw.textContent = window.__APP_PASSWORD__ ? 'set' : 'not set';
    pwSet.textContent = window.__APP_PASSWORD__ ? '*** (set)' : 'no';
    renderHost.textContent = location.hostname;

    const qInput = document.getElementById('q');
    const resultsEl = document.getElementById('results');
    const searchStatus = document.getElementById('searchStatus');
    const dayInput = document.getElementById('agendaDay');
    const agendaList = document.getElementById('agendaList');
    const agendaStatus = document.getElementById('agendaStatus');

    dayInput.value = new Date().toISOString().slice(0,10);

    function showDebug(text){ debugPre.textContent = text; }

    function makeCard(item){
      const wrap = document.createElement('div'); wrap.className='card-item';
      const left = document.createElement('div');
      const a = document.createElement('a'); a.href='#'; a.textContent = `${item.cui || item.id || ''} • ${item.name || item.denumire || ''}`;
      a.onclick = (e)=>{ e.preventDefault(); loadFirm(item.cui || item.id); };
      left.appendChild(a);
      const meta = document.createElement('div'); meta.className='card-meta';
      meta.textContent = item.judet ? `${item.judet} • ${item.cifra_afaceri ?? ''}` : '';
      wrap.appendChild(left); wrap.appendChild(meta);
      return wrap;
    }

    // Search with graceful 404 and debug
    async function doSearch(){
      const q = (qInput.value||'').trim();
      if(!q){ searchStatus.textContent='Introduceți ceva.'; return; }
      searchStatus.textContent='Căutare...'; resultsEl.innerHTML='';
      try {
        const url = `/search?q=${encodeURIComponent(q)}&limit=12`;
        const res = await fetch(url);
        const body = await res.text();
        if (res.status === 404) {
          resultsEl.innerHTML = `<div class="muted">Not Found</div>`;
          showDebug(`SEARCH 404\nGET ${window.__API_BASE__}/search?q=${encodeURIComponent(q)}\n${body}`);
          searchStatus.textContent=''; return;
        }
        if(!res.ok){ searchStatus.innerHTML = `<span class="error">Eroare: ${res.status}</span>`; showDebug(`SEARCH ${res.status}\n${body}`); return; }
        const rows = JSON.parse(body || '[]');
        if(!rows || rows.length===0) resultsEl.innerHTML = `<div class="muted">Not Found</div>`;
        else rows.forEach(r=>resultsEl.appendChild(makeCard(r)));
        searchStatus.textContent=''; showDebug(`SEARCH OK — ${rows.length} rows`);
      } catch(e){ console.error(e); searchStatus.innerHTML=`<span class="error">Eroare (rețea)</span>`; showDebug(String(e)); }
    }

    // Load firm details
    async function loadFirm(cui){
      agendaStatus.textContent='Încărcare firmă...'; agendaList.innerHTML='';
      try {
        const res = await fetch(`/api/firms/${encodeURIComponent(cui)}`);
        const body = await res.text();
        if (res.status === 404) { agendaStatus.innerHTML = `<span class="error">Firmă negăsită</span>`; showDebug(`FIRM 404\nGET ${window.__API_BASE__}/api/firms/${encodeURIComponent(cui)}\n${body}`); return; }
        if(!res.ok){ agendaStatus.innerHTML = `<span class="error">Firmă: ${res.status}</span>`; showDebug(`FIRM ${res.status}\n${body}`); return; }
        const obj = JSON.parse(body);
        const tpl = document.getElementById('detail-template').content.cloneNode(true);
        tpl.querySelector('[data-name]').textContent = obj.name || obj.denumire || obj.id || cui;
        tpl.querySelector('[data-meta]').textContent = `CUI: ${obj.cui || ''} • ${obj.judet || ''}`;
        tpl.querySelector('[data-right]').textContent = `Licente: ${obj.licente || 0}`;
        agendaList.innerHTML = ''; agendaList.appendChild(tpl);
        agendaStatus.textContent=''; showDebug(`Loaded firm ${cui}`);
      } catch(e){ console.error(e); agendaStatus.innerHTML=`<span class="error">Eroare la încărcare firmă</span>`; showDebug(String(e)); }
    }

    // Load agenda with graceful handling
    async function loadAgenda(){
      agendaStatus.textContent='Încărcare agenda...'; agendaList.innerHTML='';
      try {
        const day = dayInput.value;
        const res = await fetch(`/api/agenda?day=${encodeURIComponent(day)}`);
        const body = await res.text();
        if (res.status === 404) { agendaList.innerHTML = `<div class="muted">Agenda nu a fost găsită</div>`; showDebug(`AGENDA 404\nGET ${window.__API_BASE__}/api/agenda?day=${encodeURIComponent(day)}\n${body}`); agendaStatus.textContent=''; return; }
        if(!res.ok){ agendaStatus.innerHTML = `<span class="error">Eroare: ${res.status}</span>`; showDebug(`AGENDA ${res.status}\n${body}`); return; }
        const data = JSON.parse(body || '{}');
        const items = (data.scheduled||[]).concat(data.overdue||[]).concat(data.nearby||[]);
        if(items.length===0) agendaList.innerHTML = `<div class="muted">Agenda goală pentru ${day}</div>`;
        else { agendaList.innerHTML=''; items.slice(0,50).forEach(it=>{ const el=document.createElement('div'); el.className='agenda-item'; el.innerHTML=`<div><strong>${it.firm_name||it.cui}</strong><div class="muted">${it.comment||''}</div></div><div class="card-meta">${it.scheduled_date||''}</div>`; agendaList.appendChild(el); }); }
        agendaStatus.textContent=''; showDebug(`AGENDA OK — ${items.length} items`);
      } catch(e){ console.error(e); agendaStatus.innerHTML=`<span class="error">Eroare la încărcare agenda</span>`; showDebug(String(e)); }
    }

    // Quick health check
    (async function quick(){ try{ const h = await fetch('/health'); document.getElementById('healthStatus').textContent = h.status; }catch(e){ document.getElementById('healthStatus').textContent='fail'; showDebug(String(e)); } })();

    // Bindings
    document.getElementById('btnSearch').addEventListener('click', doSearch);
    document.getElementById('btnClear').addEventListener('click', ()=>{ qInput.value=''; resultsEl.innerHTML=''; searchStatus.textContent=''; });
    document.getElementById('loadSample').addEventListener('click', ()=>{ qInput.value='10890801'; doSearch(); });
    document.getElementById('btnAgenda').addEventListener('click', loadAgenda);
    document.getElementById('btnRefreshAll').addEventListener('click', ()=>{ loadAgenda(); doSearch(); });

    // Password overlay logic (sessionStorage)
    (function(){ const PASSWORD='5864'; const KEY='app_boot_auth'; const overlay=document.getElementById('pw-overlay'); const bootInput=document.getElementById('boot-password'); const submit=document.getElementById('pw-submit'); const cancel=document.getElementById('pw-cancel'); const err=document.getElementById('pw-error'); const appRoot=document.getElementById('app-root');
      function showApp(){ overlay.setAttribute('aria-hidden','true'); overlay.style.display='none'; appRoot.setAttribute('aria-hidden','false'); }
      function hideApp(){ overlay.setAttribute('aria-hidden','false'); overlay.style.display='flex'; appRoot.setAttribute('aria-hidden','true'); }
      submit.addEventListener('click', ()=>{ err.textContent=''; if(String(bootInput.value)==PASSWORD){ try{ sessionStorage.setItem(KEY,'1') }catch(e){} showApp(); } else { err.textContent='Parolă greșită'; } bootInput.value=''; });
      cancel.addEventListener('click', ()=>{ err.textContent='Acces refuzat'; bootInput.value=''; });
      try{ if(sessionStorage.getItem(KEY)==='1') showApp(); else hideApp(); }catch(e){ hideApp(); }
    })();

    // expose debug
    window.__showDebug = showDebug;
  </script>
</body>
</html>
