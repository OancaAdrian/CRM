<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRM</title>

  <meta name="app-password" content="5864">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; margin: 16px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px }
    label { min-width:120px; }
    input[type="text"], input[type="date"]{ padding:8px; width:300px; }
    button{ padding:8px 12px; }
    #results, #agenda { margin-top:12px; border:1px solid #ddd; padding:12px; border-radius:6px; background:#fafafa; }
    .error { color:#900; font-weight:600; }
    pre { white-space:pre-wrap; word-break:break-word; }
  </style>

  <script>
    window.__API_BASE__ = (function(){ try { return window.location.origin; } catch(e) { return ''; } })();

    (function(){
      const origFetch = window.fetch.bind(window);
      const APP_PW_META = document.querySelector('meta[name="app-password"]');
      const APP_PASSWORD = APP_PW_META ? (APP_PW_META.getAttribute('content') || '') : '';
      window.__APP_PASSWORD__ = APP_PASSWORD;

      window.fetch = function(input, init){
        init = init || {};
        init.headers = new Headers(init.headers || {});
        try {
          let url = typeof input === 'string' ? input : (input && input.url) || '';
          if (url.startsWith('/api') || url.startsWith('/admin')) {
            url = window.__API_BASE__ + url;
          } else {
            url = url.replace('onender.com', window.location.hostname).replace('openender.com', window.location.hostname);
          }
          if (url.includes('/api/') || url.includes('/admin/')) {
            if (!init.headers.get('x-app-password') && APP_PASSWORD) init.headers.set('x-app-password', APP_PASSWORD);
            if (!init.headers.get('Content-Type') && (init.body && typeof init.body === 'object')) {
              init.headers.set('Content-Type', 'application/json');
            }
          }
          input = url;
        } catch(e){ console.error('fetch wrapper error', e); }
        return origFetch(input, init);
      };
    })();
  </script>
</head>
<body>
  <h1>CRM - Interfaţă</h1>

  <section>
    <div class="row">
      <label for="q">Găsește firmă după CUI sau nume</label>
      <input id="q" type="text" placeholder="Introduceți CUI sau nume" />
      <button id="btnSearch">Caută</button>
      <span id="searchStatus"></span>
    </div>

    <div id="results">
      Rezultatele apar mai jos. Click pe nume pentru detalii.
      <div id="resultsList"></div>
    </div>
  </section>

  <section style="margin-top:18px;">
    <div class="row">
      <label for="agendaDay">Agenda pentru:</label>
      <input id="agendaDay" type="date" />
      <button id="btnAgenda">Reîmprospătează</button>
      <span id="agendaStatus"></span>
    </div>

    <div id="agenda">
      <div id="agendaContent">Agenda încărcată va apărea aici.</div>
    </div>
  </section>

  <section style="margin-top:16px;">
    <h3>Debug</h3>
    <div>API base: <code id="apiBase"></code></div>
    <div>App password (meta): <code id="appPw"></code></div>
    <div id="debug"></div>
  </section>

  <script>
    document.getElementById('apiBase').textContent = window.__API_BASE__ || '<unknown>';
    document.getElementById('appPw').textContent = window.__APP_PASSWORD__ ? '*** (set)' : '<not set>';

    const qInput = document.getElementById('q');
    const resultsList = document.getElementById('resultsList');
    const searchStatus = document.getElementById('searchStatus');

    const dayInput = document.getElementById('agendaDay');
    const agendaContent = document.getElementById('agendaContent');
    const agendaStatus = document.getElementById('agendaStatus');

    (function setDefaultDay(){
      const d = new Date();
      dayInput.value = d.toISOString().slice(0,10);
    })();

    async function doSearch(){
      const q = (qInput.value || '').trim();
      if (!q) { searchStatus.textContent = 'Introduceți ceva.'; return; }
      searchStatus.textContent = 'Căutare...';
      resultsList.innerHTML = '';
      try {
        const url = `${window.__API_BASE__}/search?q=${encodeURIComponent(q)}&limit=10`;
        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text();
          searchStatus.innerHTML = `<span class="error">Eroare: ${res.status}</span>`;
          document.getElementById('debug').innerText = `SEARCH ERROR ${res.status}\n${txt}`;
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          resultsList.innerHTML = '<div><em>Not Found</em></div>';
        } else {
          const frag = document.createDocumentFragment();
          data.forEach(it => {
            const div = document.createElement('div');
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = `${it.cui} — ${it.name || ''}`;
            a.onclick = async (e) => { e.preventDefault(); await loadFirm(it.cui); };
            div.appendChild(a);
            frag.appendChild(div);
          });
          resultsList.appendChild(frag);
        }
        searchStatus.textContent = '';
      } catch(err){
        console.error(err);
        searchStatus.innerHTML = `<span class="error">Eroare (console)</span>`;
        document.getElementById('debug').innerText = String(err);
      }
    }

    async function loadFirm(cui){
      agendaStatus.textContent = 'Încărcare firmă...';
      try {
        const url = `${window.__API_BASE__}/api/firms/${encodeURIComponent(cui)}`;
        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text();
          agendaStatus.innerHTML = `<span class="error">Firmă: ${res.status}</span>`;
          document.getElementById('debug').innerText = `FIRM ERROR ${res.status}\n${txt}`;
          return;
        }
        const obj = await res.json();
        agendaContent.innerHTML = `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
        agendaStatus.textContent = '';
      } catch(err){
        console.error(err);
        agendaStatus.innerHTML = `<span class="error">Eroare la încărcare firmă</span>`;
        document.getElementById('debug').innerText = String(err);
      }
    }

    async function loadAgenda(){
      agendaStatus.textContent = 'Încărcare agenda...';
      agendaContent.innerHTML = '';
      try {
        const day = dayInput.value;
        const url = `${window.__API_BASE__}/api/agenda?day=${encodeURIComponent(day)}`;
        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text();
          agendaStatus.innerHTML = `<span class="error">Eroare: ${res.status}</span>`;
          document.getElementById('debug').innerText = `AGENDA ERROR ${res.status}\n${txt}`;
          return;
        }
        const data = await res.json();
        agendaContent.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        agendaStatus.textContent = '';
      } catch(err){
        console.error(err);
        agendaStatus.innerHTML = `<span class="error">Eroare la încărcare agenda</span>`;
        document.getElementById('debug').innerText = String(err);
      }
    }

    document.getElementById('btnSearch').addEventListener('click', doSearch);
    document.getElementById('btnAgenda').addEventListener('click', loadAgenda);

    (async function quickChecks(){
      try {
        const h = await fetch(`${window.__API_BASE__}/health`);
        document.getElementById('debug').innerText = `/health: ${h.status}`;
      } catch(e){ document.getElementById('debug').innerText = `/health failed: ${e}`; }

      try {
        const t = await fetch(`${window.__API_BASE__}/api/test_firm`);
        if (t.ok) {
          const json = await t.json();
          document.getElementById('debug').innerText += `\n/api/test_firm: ok, rows=${(json.rows && json.rows.length) || 'n/a'}`;
        } else {
          document.getElementById('debug').innerText += `\n/api/test_firm: ${t.status}`;
        }
      } catch(e){ /* ignore */ }
    })();
  </script>
</body>
</html>
