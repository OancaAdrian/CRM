<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRM - Interfaţă</title>

  <!-- TEMPORAR: setare parolă aici doar pentru test. În producție nu publica parola -->
  <meta name="app-password" content="5864">

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 16px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap }
    label { min-width:140px; }
    input[type="text"], input[type="date"]{ padding:8px; width:320px; max-width:60vw; }
    button{ padding:8px 12px; }
    #results, #agenda { margin-top:12px; border:1px solid #ddd; padding:12px; border-radius:6px; background:#fafafa; }
    .error { color:#900; font-weight:700; }
    pre { white-space:pre-wrap; word-break:break-word; background:#fff; padding:8px; border-radius:4px; border:1px solid #eee; }
    small.meta { color:#666; }
  </style>

  <script>
    // Resolve API base from current origin; prevents hardcoded/broken hostnames
    window.__API_BASE__ = (function(){ try { return window.location.origin; } catch(e) { return ''; } })();

    // Read app password from meta (for tests only)
    (function(){
      const APP_PW_META = document.querySelector('meta[name="app-password"]');
      window.__APP_PASSWORD__ = APP_PW_META ? (APP_PW_META.getAttribute('content') || '') : '';
    })();

    // global fetch wrapper: prefix relative /api and /admin calls with correct origin,
    // fix known bad hosts, and inject x-app-password header if available
    (function(){
      const originalFetch = window.fetch.bind(window);
      window.fetch = async function(input, init){
        init = init || {};
        init.headers = new Headers(init.headers || {});
        let url = typeof input === 'string' ? input : (input && input.url) || '';
        try {
          // fix common build-time typos (onender/openender) -> current host
          url = url.replace('onender.com', window.location.hostname).replace('openender.com', window.location.hostname);

          // if relative path to api/admin, prefix with current origin
          if (url.startsWith('/api') || url.startsWith('/admin')) {
            url = window.__API_BASE__ + url;
          }

          // inject app password for protected endpoints if present in meta
          if ((url.includes('/api/') || url.includes('/admin/')) && window.__APP_PASSWORD__) {
            if (!init.headers.get('x-app-password')) init.headers.set('x-app-password', window.__APP_PASSWORD__);
          }

          // ensure JSON content-type when body is plain object
          if (init.body && typeof init.body === 'object' && !init.headers.get('Content-Type')) {
            init.headers.set('Content-Type', 'application/json');
            init.body = JSON.stringify(init.body);
          }
        } catch(e){
          console.error('fetch wrapper error', e);
        }
        return originalFetch(url, init);
      };
    })();
  </script>
</head>
<body>
  <h1>CRM - Interfaţă</h1>

  <section>
    <div class="row">
      <label for="q">Găsește firmă după CUI sau nume</label>
      <input id="q" type="text" placeholder="Introduceți CUI sau nume" />
      <button id="btnSearch">Caută</button>
      <span id="searchStatus" class="meta"></span>
    </div>

    <div id="results">
      <div>Rezultatele apar mai jos. Click pe nume pentru detalii.</div>
      <div id="resultsList" style="margin-top:8px"></div>
    </div>
  </section>

  <section style="margin-top:18px;">
    <div class="row">
      <label for="agendaDay">Agenda pentru</label>
      <input id="agendaDay" type="date" />
      <button id="btnAgenda">Reîmprospătează</button>
      <span id="agendaStatus" class="meta"></span>
    </div>

    <div id="agenda">
      <div id="agendaContent">Agenda încărcată va apărea aici.</div>
    </div>
  </section>

  <section style="margin-top:16px;">
    <h3>Debug</h3>
    <div>API base: <code id="apiBase"></code></div>
    <div>App password (meta): <code id="appPw"></code></div>
    <div id="debug" style="margin-top:8px"><pre id="debugPre"></pre></div>
  </section>

  <script>
    // UI refs
    document.getElementById('apiBase').textContent = window.__API_BASE__ || '<unknown>';
    document.getElementById('appPw').textContent = window.__APP_PASSWORD__ ? '*** (set)' : '<not set>';

    const qInput = document.getElementById('q');
    const resultsList = document.getElementById('resultsList');
    const searchStatus = document.getElementById('searchStatus');

    const dayInput = document.getElementById('agendaDay');
    const agendaContent = document.getElementById('agendaContent');
    const agendaStatus = document.getElementById('agendaStatus');

    const debugPre = document.getElementById('debugPre');

    // default date
    (function setDefaultDay(){
      const d = new Date();
      dayInput.value = d.toISOString().slice(0,10);
    })();

    function showDebug(msg){
      debugPre.textContent = msg;
    }

    async function doSearch(){
      const q = (qInput.value || '').trim();
      if (!q) { searchStatus.textContent = 'Introduceți ceva.'; return; }
      searchStatus.textContent = 'Căutare...';
      resultsList.innerHTML = '';
      try {
        const url = `/search?q=${encodeURIComponent(q)}&limit=10`;
        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text();
          searchStatus.innerHTML = `<span class="error">Eroare: ${res.status}</span>`;
          showDebug(`SEARCH ERROR ${res.status}\n${txt}`);
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          resultsList.innerHTML = '<div><em>Not Found</em></div>';
        } else {
          const frag = document.createDocumentFragment();
          data.forEach(it => {
            const div = document.createElement('div');
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = `${it.cui} — ${it.name || ''}`;
            a.onclick = async (e) => { e.preventDefault(); await loadFirm(it.cui); };
            div.appendChild(a);
            frag.appendChild(div);
          });
          resultsList.appendChild(frag);
        }
        searchStatus.textContent = '';
      } catch(err){
        console.error(err);
        searchStatus.innerHTML = `<span class="error">Eroare (console)</span>`;
        showDebug(String(err));
      }
    }

    async function loadFirm(cui){
      agendaStatus.textContent = 'Încărcare firmă...';
      try {
        const url = `/api/firms/${encodeURIComponent(cui)}`;
        const res = await fetch(url);
        const bodyText = await res.text();
        if (!res.ok) {
          agendaStatus.innerHTML = `<span class="error">Firmă: ${res.status}</span>`;
          showDebug(`FIRM ERROR ${res.status}\n${bodyText}`);
          return;
        }
        const obj = JSON.parse(bodyText);
        agendaContent.innerHTML = `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
        agendaStatus.textContent = '';
        showDebug(`Loaded firm ${cui}`);
      } catch(err){
        console.error(err);
        agendaStatus.innerHTML = `<span class="error">Eroare la încărcare firmă</span>`;
        showDebug(String(err));
      }
    }

    async function loadAgenda(){
      agendaStatus.textContent = 'Încărcare agenda...';
      agendaContent.innerHTML = '';
      try {
        const day = dayInput.value;
        const url = `/api/agenda?day=${encodeURIComponent(day)}`;
        const res = await fetch(url);
        const bodyText = await res.text();
        if (!res.ok) {
          agendaStatus.innerHTML = `<span class="error">Eroare: ${res.status}</span>`;
          showDebug(`AGENDA ERROR ${res.status}\n${bodyText}`);
          return;
        }
        const data = JSON.parse(bodyText);
        agendaContent.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        agendaStatus.textContent = '';
        showDebug(`AGENDA OK — loaded ${data.scheduled?.length || 0} scheduled items`);
      } catch(err){
        console.error(err);
        agendaStatus.innerHTML = `<span class="error">Eroare la încărcare agenda</span>`;
        showDebug(String(err));
      }
    }

    document.getElementById('btnSearch').addEventListener('click', doSearch);
    document.getElementById('btnAgenda').addEventListener('click', loadAgenda);

    // quick network checks
    (async function quickChecks(){
      try {
        const h = await fetch('/health');
        showDebug(`/health: ${h.status}`);
      } catch(e){ showDebug(`/health failed: ${e}`); }

      // test optional endpoint if present
      try {
        const t = await fetch('/api/test_firm');
        if (t.ok) {
          const json = await t.json();
          showDebug(debugPre.textContent + `\n/api/test_firm: ok, rows=${(json.rows && json.rows.length) || 'n/a'}`);
        } else {
          showDebug(debugPre.textContent + `\n/api/test_firm: ${t.status}`);
        }
      } catch(e){ /* ignore */ }
    })();
  </script>
</body>
</html>
